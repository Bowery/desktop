<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-core` is the bowery desktop app

@group Bowery Core Elements
@element bowery-core
-->
<link rel="import" href="bowery-screen.html">
<link rel="import" href="bowery-nav.html">
<link rel="import" href="bowery-apps.html">
<link rel="import" href="bowery-form.html">
<link rel="import" href="bowery-shell.html">
<link rel="import" href="bowery-analytics.html">
<link rel="import" href="../core-localstorage/core-localstorage.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<polymer-element name="bowery-core" attributes="developer">
<template>
<bowery-analytics id="analytics"></bowery-analytics>
<core-localstorage id="db" name="bowery-developer" value="{{developer}}"></core-localstorage>
<core-localstorage id="keys" name="aws-keys" value="{{keys}}"></core-localstorage>
<link rel="stylesheet" href="../../bowery/out.css">
<style>
  span, pre {
    color: white;
  }
  :host {
    overflow: hidden;
  }

  .test-modal {
    position: relative;
    background: white;
    height: 45px;
    width: 345px;
    margin-top: 80px;
    margin-left: 9px;
  }
</style>
<bowery-nav type="header">Bowery</bowery-nav>

<bowery-screen path="/login">
  <bowery-form title="login" on-bowery-form-response="{{handleLoginAttempt}}" endpoint="http://broome.io/developers/token" fields="{{loginFields}}" sendAs="json">
    <a href="/signup" on-click="{{navigate}}">I don't have a bowery account.</a>
  </bowery-form>
</bowery-screen>

<bowery-screen path="/signup">
  <bowery-form title="signup" endpoint="http://broome.io/developers" fields="{{signupFields}}" on-bowery-form-response="{{handleSignupAttempt}}" sendAs="json">
    <a href="/login" on-click="{{navigate}}">I already have a bowery account.</a>
  </bowery-form>
</bowery-screen>

<bowery-screen path="/apps">
  <bowery-apps app="{{app}}" applications="{{applications}}"></bowery-apps>
  <bowery-nav type="footer" href="/apps/new" on-click="{{navigate}}">Create App</bowery-nav>
</bowery-screen>

<bowery-screen path="/apps/status">
  <bowery-shell app="{{app}}" logs="{{app.logs}}" token="{{developer.token}}">
    <a href="/apps" on-click="{{navigate}}">I'm over it. Take me home.</a>
  </bowery-shell>
  <bowery-nav type="footer" href="/apps/edit" on-click="{{navigate}}">Edit App</bowery-nav>
</bowery-screen>

<bowery-screen path="/apps/edit">
  <bowery-form title="Save" endpoint="/applications/{{app._id}}" model="{{app}}" fields="{{editAppFields}}" sendAs="json" on-bowery-form-response="{{handleEditAppAttempt}}" token="{{developer.token}}">
    <a href="/apps/status" on-click="{{navigate}}">Nevermind. Take me back.</a> |
    <a href="" on-click="{{deleteApp}}" class="error">Delete This App</a>
  </bowery-form>
</bowery-screen>

<bowery-screen path="/apps/new">
  <bowery-form title="Provision" endpoint="/applications" fields="{{newAppFields}}" sendAs="json" on-bowery-form-response="{{handleCreateAppAttempt}}" token="{{developer.token}}">
    <a href="/apps" on-click="{{navigate}}">I'm lost. Take me home.</a> | <a href="https://console.aws.amazon.com/iam/#users" on-click="{{openExternalWindow}}">What are AWS Keys?</a>
  </bowery-form>
</bowery-screen>
<core-ajax id="ajax" handleAs="json" on-core-response="{{getUserByToken}}" auto></core-ajax>
<core-ajax id="appsAjax" handlAs="json" on-core-response="{{getApps}}" on-core-error="{{logout}}" url="/applications?token={{developer.token}}" auto></core-ajax>
<core-ajax id="deleteAppAjax" method="DELETE" handleAs="json" on-core-response="{{handleDeleteAppAttempt}}" auto></core-ajax>
</template>
<script src="gifstream.js"></script>
<script>
Polymer('bowery-core', {
  created: function () {
    // The current app being shown
    this.app = {}

    // All of the current users application
    this.applications = []

    // The current user
    this.developer = {}

    // AWS credentials
    this.keys = {
      aws_access_key: "",
      aws_secret_key: ""
    }
  },
  loginFields: [
    {name: 'email'},
    {name: 'password', type: 'password'}
  ],
  signupFields: [
    {name: 'name'},
    {name: 'email'},
    {name: 'password', type: 'password'}
  ],
  editAppFields: [
    {name: 'name'},
    {name: 'start'},
    {name: 'build'},
    {name: 'remotePath', label: 'Remote Path'},
    {name: 'localPath', label: 'Local Path'}
  ],
  newAppFields: [
    {name: 'aws_access_key', label: 'AWS Key'},
    {name: 'aws_secret_key', label: 'AWS Secret'},
     {name: 'envID', label: 'Environment'},
    {name: 'instance_type', label: 'Size', type: 'pill', options: ["m1.small", "m1.medium", "m1.large"]}
  ],
  ready: function () {
    this.$.analytics.track("Opened App")

    // Drag & Drop Swag
    window.addEventListener('dragenter', function (e) {
      e.stopPropagation()
      e.preventDefault()
    })
    window.addEventListener('dragover', function (e) {
      e.stopPropagation()
      e.preventDefault()
    })
    window.addEventListener('drop', this.createAppFromDroppedImage.bind(this))

    this.$.db.load()
    this.$.keys.load()

    var sse = new EventSource('/_/sse')
    sse.addEventListener('message', this.handleSSE.bind(this))

    if (!this.developer.token) {
      return this.navigate('/login')
    }

    this.newAppFields[0].value = this.keys.aws_access_key
    this.newAppFields[1].value = this.keys.aws_secret_key

    this.navigate('/apps')
  },
  createAppFromDroppedImage: function (e) {
    e.preventDefault()
    var file = e.dataTransfer.files[0];
    if (file.type != "image/gif") {
      return alert("File must be a gif, not " + file.type)
    }
    var self = this
    var reader = new FileReader();
    reader.onload = function (evt) {
      (new GifStream(evt.target.result)).parseID(self.populateNewAppScreen.bind(self))
      // TODO (thebyrd) Navigate to Create App Page w/ the environment ID already set
    }
    reader.readAsBinaryString(file)
  },
  populateNewAppScreen: function (comExt) {
    var envID = comExt && comExt.comment

    if (envID) this.newAppFields[2].value = envID

    this.app = {}
    this.navigate("/apps/new")
  },
  handleSSE: function (e) {
    var event = JSON.parse(e.data)

    console.log('$$$ sse', event)

    if (event.type == 'status') {
      for (var i in this.applications) {
        if (event.appID == this.applications[i]._id) {
          this.applications[i] = event.message
        }
      }
      return
    }

    if (event.type == 'log' && this.app._id == event.appID && event.message) {
      this.app.logs += event.message
    }
  },
  handleCreateAppAttempt: function (e, detail) {
    console.log('$$$ handle create app', arguments)
    var response = e.target.response
    if (response.status != 'success') {
      if (response.error == "EOF") return

      this.$.analytics.track("Failed to Create App", {error: response.error})
      e.target.feedback = response.error
      return
    }

    this.app = response.application
    this.applications.push(this.app)
    for (var i = 0, field; field = this.editAppFields[i]; i++)
      field.value = this.app[field.name]

    this.keys.aws_access_key = detail.model.aws_access_key
    this.keys.aws_secret_key = detail.model.aws_secret_key
    this.$.keys.save()

    this.navigate('/apps/edit')
  },
  handleEditAppAttempt: function (e, detail) {
    var response = e.target.response
    if (response.status != 'success') {
      if (response.error == "EOF") return

      this.$.analytics.track("Failed to Edit App", {error: response.error})
      e.target.feedback = response.error
      return
    }

    this.app = detail.model
    for (var i = 0, app; app = this.applications[i]; i++)
      if (app._id == this.app._id)
        this.applications[i] = this.app

    this.navigate('/apps')
  },
  handleLoginAttempt: function (e) {
    var response = e.target.response
    if (response.status != "created") {
      if (response.error == "EOF") return

      this.$.analytics.track("Failed Login Attempt", {error: response.error})
      e.target.feedback = response.error
      return
    }
    this.developer = {}
    this.developer.token = response.token
    this.$.ajax.url = "http://broome.io/developers/me?token=" + this.developer.token

    this.navigate('/apps')
  },
  getUserByToken: function (e) {
    var response = e.target.response
    if (response.status == "found") {
      this.developer = response.developer
      this.developer['$email'] = this.developer.email // bullshit => https://mixpanel.com/docs/properties-or-segments/special-or-reserved-properties
      this.$.analytics.register(this.developer)
    }
  },
  handleSignupAttempt: function (e) {
    var response = e.target.response
    if (response.status == "created") {
      this.developer = response.developer
      this.$.db.save()
      return this.navigate('/apps')
    }

    if (response.error == "EOF")
      return

    this.$.analytics.track("Failed Signup Attempt", {error: response.error})
    e.target.feedback = response.error
  },
  parameterize: function (obj) {
    var out = ""
    for (var key in obj) {
      out += key + "=" + obj[key] + "&"
    }
    return out
  },
  deleteApp: function (e) {
    e.preventDefault()
    var tokens = {
      token: this.developer.token,
      aws_access_key: encodeURIComponent(this.keys.aws_access_key),
      aws_secret_key: encodeURIComponent(this.keys.aws_secret_key)
    }
    var id = this.app._id
    this.$.deleteAppAjax.url = "/applications/" + id + "?" + this.parameterize(tokens)
    this.applications = this.applications.filter(function (a) {return a._id != id})
    this.app = {}
  },
  getApps: function (e, detail) {
    var r = JSON.parse(detail.response)
    if (r.status == "found")
      this.applications = r.applications
    else
      this.logout()
  },
  handleDeleteAppAttempt: function (e) {
    var response = e.target.response
    if (response.status == 'success') {

      this.applications = this.applications.filter(function (app) {
        return app._id != response.id
      })

      return this.navigate('/apps')
    }
    alert('unable to delete ')
  },
  openExternalWindow: function (path) {
    if (typeof path != "string") {
      var e = path
      e.preventDefault()
      path = e.target.getAttribute('href')
    }
    this.$.analytics.track('Opened external window ' + path)
    window.open(path, "", "resizable,scrollbars,status")
  },
  navigate: function (path) {
    var self = this
    if (typeof path != "string") {
      var e = path
      e.preventDefault()
      path = e.target.getAttribute('href')
    }

    this.$.analytics.track('Navigated to ' + path)


    this.fire('bowery-navigate', {path: path})
  },
  logout: function () {
    this.developer = {}
    this.$.db.save()
    this.navigate('/login')
  },
  getAppById: function (e) {
    var response = e.target.response
    if (response.status == 'found') {
      this.app = response.application
      for (var i = 0; i < this.applications.length; i++)
        if (this.app._id == this.applications[i]._id)
          this.applications[i] = this.app
    }
  }
})
</script>
</polymer-element>
