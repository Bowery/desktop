<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-form` is a bunch of text fields with a submit button.
  <bowery-form></bowery-form>

@group Bowery Core Elements
@element bowery-form
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">


<polymer-element name="bowery-form" attributes="fields title endpoint sendAs response feedback">
<template>
  <link rel="stylesheet" href="../../bowery/out.css">
  <style>
  form {
    padding-top: 9px;
    overflow: auto;
  }

  .extra {
    margin: 9px 18px 0 18px;
    padding: 10px;
  }


  </style>
  <form id="form">
    <!-- TODO (thebyrd) replace with error modal used for everything else. -->
    <template repeat="{{field in fields}}">
      <div class="field-group">
        <label for="{{field}}">{{field | makeReadable}}</label>
        <input id="{{field}}" type="{{field == 'password' ? 'password' : 'text'}}" name="{{field}}" on-keyup="{{submitIfEnter}}">
      </div>
    </template>
  </form>
  <div class="extra">
    <content></content>
    <p>{{feedback}}</p>
  </div>

  <bowery-nav type="footer" on-click="{{postForm}}">{{title}}</bowery-nav>
  <core-ajax id="ajax"
    auto
    url="{{endpoint}}"
    method="POST"
    on-core-complete="{{emitResult}}"
    handleAs="json">
  </core-ajax>
</template>
<script>
Polymer({
  ready: function () {
    this.fields = this.fields.split(" ")
    this.type = "login"
  },
  makeReadable: function (str) {
    strs = str.replace('-', ' ').replace('_', ' ').split(' ')
    return strs.map(function (str) {
      return str.charAt(0).toUpperCase() + str.slice(1)
    }).join(' ')

  },
  submitIfEnter: function (e) {
    if (e.keyCode == 13) this.postForm(e)
  },
  postForm: function (e) {
    e.preventDefault()
    var params = {}
    for (var i = 0, field; field = this.fields[i]; i++)
      params[field] = this.$.form[field].value

    if (this.sendAs == "json") {
      this.$.ajax.contentType = "application/json"
      this.$.ajax.body = JSON.stringify(params)
    }

    this.$.ajax.params = JSON.stringify(params)
  },
  emitResult: function (e, detail) {

    try {
      this.response = JSON.parse(detail.xhr.responseText)
    } catch (e) {
      console.log(detail.xhr.responseText)
      this.response = {
        status: 'failed',
        error: 'internal server error'
      }
    }

    this.fire('bowery-form-response')
  }
})
</script>
</polymer-element>
