<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-form` is a bunch of text fields with a submit button.
  <bowery-form></bowery-form>

@group Bowery Core Elements
@element bowery-form
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">


<polymer-element name="bowery-form" attributes="fields title endpoint sendAs response">
<template>
  <link rel="stylesheet" href="../../bowery/out.css">
  <style>
  form {
    padding: 55px 0;
    overflow: auto;
  }
  #feedback {
    /*background: white;*/
    color: rgb(251, 77, 83);
    width: 345px;
    float: left;
    position: relative;
    overflow: hidden;
    transition: opacity 300ms ease-in;
    margin: 9px 18px 0 18px;
    padding: 10px;
    opacity: 0;

  }

  .visible#feedback {
    opacity: 1;
  }


  </style>
  <form id="form">
    <span id="feedback">feedback</span>
    <!-- TODO (thebyrd) replace with error modal used for everything else. -->
    <template repeat="{{field in fields}}">
      <div class="field-group">
        <label for="{{field}}">{{field | makeReadable}}</label>
        <input id="{{field}}" type="{{field == 'password' ? 'password' : 'text'}}" name="{{field}}">
      </div>
    </template>
  </form>

  <bowery-nav type="footer" on-click="{{postForm}}">{{title}}</bowery-nav>
  <core-ajax id="ajax"
    auto
    url="{{endpoint}}"
    method="POST"
    on-core-complete="{{emitResult}}"
    handleAs="json">
  </core-ajax>
</template>
<script>
Polymer({
  ready: function () {
    this.fields = this.fields.split(" ")
    this.type = "login"
  },
  makeReadable: function (str) {
    strs = str.replace('-', ' ').replace('_', ' ').split(' ')
    return strs.map(function (str) {
      return str.charAt(0).toUpperCase() + str.slice(1)
    }).join(' ')

  },
  giveFeedback: function (msg) {
    if (msg == 'EOF') // TODO (sjkaliski) Broome shouldn't send EOF
      return

    var el = this.$.feedback
    el.innerHTML = msg
    el.className = "visible"
    setTimeout(function () {
      el.className = ""
    }, 4000)
  },
  postForm: function (e) {
    e.preventDefault()
    var params = {}
    for (var i = 0, field; field = this.fields[i]; i++)
      params[field] = this.$.form[field].value

    if (this.sendAs == "json") {
      this.$.ajax.contentType = "application/json"
      this.$.ajax.body = JSON.stringify(params)
    }

    this.$.ajax.params = JSON.stringify(params)
  },
  emitResult: function (e, detail) {

    try {
      this.response = JSON.parse(detail.xhr.responseText)
    } catch (e) {
      console.log(detail.xhr.responseText)
      this.response = {
        status: 'failed',
        error: 'internal server error'
      }
    }

    this.fire('bowery-form-response')
  }
})
</script>
</polymer-element>
