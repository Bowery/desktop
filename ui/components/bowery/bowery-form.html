<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-form` is a bunch of text fields with a submit button.
  <bowery-form></bowery-form>

@group Bowery Core Elements
@element bowery-form
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">
<link rel="import" href="bowery-analytics.html">
<link rel="import" href="bowery-pill.html">


<polymer-element name="bowery-form" attributes="fields title endpoint sendAs response feedback token model">
<template>
  <bowery-analytics id="analytics"></bowery-analytics>
  <link rel="stylesheet" href="../../bowery/out.css">
  <style>
  form {
    padding-top: 9px;
    overflow: auto;
  }
  .extra {
    margin: 9px 18px 0 18px;
    padding: 10px;
  }
  .field-group {
    background: white;
    padding: 10px;
    margin: 9px 18px 0 18px;
    width: 345px;
    float: left;
    position: relative;
    overflow: hidden;
  }
  bowery-pill {
    float: left;
    margin: 9px 18px 0 18px;
  }
  </style>
  <form id="form">
    <template repeat="{{field in fields}}">
      <template if="{{field.type == 'pill'}}">
        <bowery-pill id="{{field.name}}" options='{{field.options}}' value="{{model[field.name]}}"></bowery-pill>
      </template>
      <template if="{{field.type != 'pill'}}">
        <div class="field-group">
          <input id="{{field.name}}" placeholder="{{field.label || field.name | makeReadable}}" type="{{field.type || 'text'}}" name="{{field.name}}" value="{{field.value || model[field.name]}}" on-keyup="{{submitIfEnter}}" on-blur="{{trackInput}}">
        </div>
      </template>
    </template>
  </form>
  <div class="extra">
    <content></content>
    <p>{{feedback}}</p>
  </div>

  <bowery-nav type="footer" on-click="{{postForm}}">{{title}}</bowery-nav>
  <core-ajax id="ajax"
    auto
    url="{{endpoint}}"
    method="POST"
    on-core-complete="{{emitResult}}"
    handleAs="json">
  </core-ajax>
</template>
<script>
Polymer({
  created: function () {
    this.fields = []
    this.model = {}
  },
  makeReadable: function (str) {
    strs = str.replace('-', ' ').replace('_', ' ').split(' ')
    return strs.map(function (str) {
      return str.charAt(0).toUpperCase() + str.slice(1)
    }).join(' ')

  },
  submitIfEnter: function (e) {
    if (e.keyCode == 13) {
      this.$.analytics.track('Submited Form with Enter Key')
      this.postForm(e)
    }
  },
  postForm: function (e) {
    e.preventDefault()
    var params = {}
    params.token = this.token

    for (var i = 0, field; field = this.fields[i]; i++)
      params[field.name] = this.model[field.name] = this.$[field.name].value

    if (this.sendAs == "json") {
      this.$.ajax.contentType = "application/json"
      this.$.ajax.body = JSON.stringify(params)
    }

    this.$.ajax.params = JSON.stringify(params)

    this.$.analytics.track('Submitted ' + this.title + ' Form', params)
  },
  emitResult: function (e, detail) {
    try {
      this.response = JSON.parse(detail.xhr.responseText)
    } catch (e) {
      this.response = {
        status: 'failed',
        error: 'internal server error'
      }
    }

    this.fire('bowery-form-response', {fields: this.fields, model: this.model})
  },
  trackInput: function (e) {
    if (!e.target.value) return // don't track if they didn't type anything

    this.$.analytics.track('Entered Input Text', {
      field: e.target.name,
      value: e.target.value
    })
  }
})
</script>
</polymer-element>
