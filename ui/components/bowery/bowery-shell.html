<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-shell` allows users to interact with their app and get meaningful feedback
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<polymer-element name="bowery-shell" attributes="app logs token">
  <template>
    <link rel="stylesheet" href="../../bowery/out.css">
    <style>
    .scrollable {
      overflow: auto;
      margin: 0;
      padding: 0;
      height: 299px;
      display: block;
    }
    .card, .field-group, .card:hover {
      background: #4C70BE;
    }
    .card h3 {
      color: white;
    }
    </style>
    <div class="field-group">
      <input id="cmd" type="text" placeholder=">" on-keyup="{{runCmdOnEnter}}">
      <label>Press enter to execute command.</label>
    </div>
    <div class="scrollable">
      <template repeat="{{event in app.environment.events}}">
        <div class="card">
          <h3>{{event.body}}</h3>
          <span class="unclickable">{{event.createdAt | timeSince}}</span>
        </div>
      </template>
    </div>
    <core-ajax id="ajax" contentType="application/json" url="/commands" method="POST" handleAs="json" on-core-response="{{handleCmdResponse}}" auto></core-ajax>
  </template>
  <script src="ansi_up.js" type="text/javascript"></script>
  <script>
    Polymer('bowery-shell', {
      created: function () {
        this.style.display = 'none'
      },
      ready: function () {
        this.style.display = 'block'
      },
      runCmd: function (e) {
        var cmd = this.$.cmd.value
        this.app.environment.events.unshift({
          body: cmd,
          createdAt: Date.now()
        })
        if (cmd) this.$.ajax.body = this.$.ajax.params = JSON.stringify({appID: this.app._id, token: this.token, cmd: cmd, cacheBuster: Date.now()})
      },
      runCmdOnEnter: function (e) {
        if (e.keyCode == 13) {
          this.runCmd()
          this.openLogsWindow()
        }
      },
      timeSince: function (date) {
        var seconds = Math.floor((new Date() - new Date(date)) / 1000)
        var interval = Math.floor(seconds / 31536000)

        if (interval > 1) {
            return interval + " years ago"
        }
        interval = Math.floor(seconds / 2592000)
        if (interval > 1) {
            return interval + " months ago"
        }
        interval = Math.floor(seconds / 86400)
        if (interval > 1) {
            return interval + " days ago"
        }
        interval = Math.floor(seconds / 3600)
        if (interval > 1) {
            return interval + " hours ago"
        }
        interval = Math.floor(seconds / 60)
        if (interval > 1) {
            return interval + " minutes ago"
        }
        return Math.floor(seconds) + " seconds ago"
      },
      openLogsWindow: function () {
        this.logWindow = this.logWindow || window.open("http://localhost:32055/bowery/logs.html?appId=" + this.app._id, this.app.name + " Logs", "resizable,scrollbars,status")
      },
      handleCmdResponse: function (e, detail) {
        this.$.cmd.value = ""
        this.openLogsWindow()
      }
    })
  </script>
</polymer-element>
