<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-shell` allows users to interact with their app and get meaningful feedback
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<polymer-element name="bowery-shell" attributes="app logs token">
  <template>
    <link rel="stylesheet" href="../../bowery/out.css">
    <style>
    #message {
      margin: 9px 18px;
    }
    .executer {
      padding: 0 18px;
      margin-bottom: 9px;
      width: 364px;
      float: left;
      position: relative;
      overflow: hidden;
    }
    label {
      top: 9px;
      left: 36px;
    }
    input {
      width: 229px;
      height: 18px;
      margin-right: 9px;
      padding: 9px 18px 9px 36px;
    }
    button {
      background: white;
      width: 72px;
      height: 36px;
      float: right;
      cursor: pointer;
      padding: 9px;
    }
    .logs {
      background: white;
      width: 364px;
      margin: 9px 18px;
      min-height: 108px;
      max-height: 234px;
      overflow: auto;
    }
    .extra {
      margin-left: 18px;
    }
    </style>
    <p id="message">All good in the hood.</p>
    <div class="executer">
      <label>></label>
      <input id="cmd" type="text" on-keyup="{{runCmdOnEnter}}">
      <button on-click="{{runCmd}}">RUN</button>
    </div>
    <div id="logs" class="logs">
      <pre>{{logs}}</pre>
    </div>
    <div class="extra">
      <content></content>
    </div>
    <core-ajax id="ajax" contentType="application/json" url="/commands" method="POST" handleAs="json" on-core-complete="{{handleCmdResponse}}" auto></core-ajax>
  </template>
  <script>
    Polymer('bowery-shell', {
      ready: function () {

      },
      runCmd: function (e) {
        var cmd = this.$.cmd.value
        if (cmd) this.$.ajax.body = this.$.ajax.params = JSON.stringify({appID: this.app._id, token: this.token, cmd: cmd})
      },
      runCmdOnEnter: function (e) {
        if (e.keyCode == 13) {
          this.runCmd()
        }
      },
      handleCmdResponse: function (e, detail) {
        var response = JSON.parse(detail.xhr.responseText)
        if (response.status == "success") {
          this.$.cmd.value = ""
          this.$.logs.scrollTop = this.$.logs.scrollHeight
        } else if (response.error != "EOF") {
          this.$.message.innerHTML = response.error
        }
      }
    })
  </script>

</polymer-element>
