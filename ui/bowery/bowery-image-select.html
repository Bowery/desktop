<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-image-select` allows you to select a bowery image from a search result.
  <bowery-image-select></bowery-image-select>

@group Bowery Core Elements
@element bowery-image-select
-->

<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/core-ajax/core-ajax.html">
<link rel="import" href="bowery-analytics.html">


<polymer-element name="bowery-image-select" attributes="images image app keys token">
  <template>
    <bowery-analytics id="analytics"></bowery-analytics>
    <link rel="stylesheet" href="out.css">
    <style>
      :host {
        height: 100%;
      }
      .card, .field-group, :host {
        background: #0C2642;
      }
      .card:hover {
        background: #072038;
      }
      .scrollable {
        height: 299px;
        background: #0C2642;
        overflow: auto;
      }
      .unclickable {
        cursor: pointer;
      }
    </style>
    <div class="field-group">
      <input type="text" placeholder="Search for images" value="{{query}}">
      <label>Click on image to provision app.</label>
    </div>
    <div class="scrollable">
      <template repeat="{{image in images}}">
        <div class="card" on-click="{{selectImage}}" data-id="{{image.id}}">
          <h4>{{image.name}}</h4>
          <span class="unclickable">{{image.description}}</span>
        </div>
      </template>
    </div>
    <core-ajax url="http://localhost:32055/environments?query={{query || 'default'}}" handleAs="json" on-core-response="{{updateImages}}" auto></core-ajax>
    <core-ajax id="ajax" url="http://localhost:32055/applications" method="POST" handleAs="json" on-core-complete="{{emitResult}}"></core-ajax>
  </template>
  <script>
  Polymer('bowery-image-select', {
    ready: function (e) {
      this.images = []
    },
    updateImages: function (e, detail) {
      console.log(detail.response && detail.response.environments)
      if (detail.response.environments.length)
        this.images = detail.response.environments.filter(function (i) {return !!i.name})
      else
        this.images = []
    },
    selectImage: function (e) {
      this.$.ajax.contentType = "application/json"
      this.$.ajax.body = JSON.stringify({
        token: this.token,
        envID: e.target.dataset.id || e.target.parentNode.dataset.id,
        aws_access_key: this.keys && this.keys.aws_access_key,
        aws_secret_key: this.keys && this.keys.aws_secret_key,
        instance_type: 'm3.medium',
        name: 'Your App'
      })
      this.$.ajax.go()
    },
    emitResult: function (e, detail) {
      try {
        this.response = JSON.parse(detail.xhr.responseText)
      } catch (e) {
        return
      }

      if (this.response.error == "internal server error") return
      if (this.response.error) {
        this.$.analytics.track("Failed Form Post Attempt (" + this.title + ")", {error: this.response.error})
        if (this.response.error == "invalid keys") {
          this.fire('bowery-navigate', {path: '/keys'})
          return
        }

        alert('Unable to create application.\n' + this.response.error)
        return
      }
      this.app = this.response.application
      this.fire('bowery-navigate', {path: '/apps/edit'})
    }
  })
  </script>
</polymer-element>
