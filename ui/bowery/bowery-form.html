<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-form` is a bunch of text fields with a submit button.
  <bowery-form></bowery-form>

@group Bowery Core Elements
@element bowery-form
-->

<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/core-ajax/core-ajax.html">
<link rel="import" href="bowery-analytics.html">

<polymer-element name="bowery-form" attributes="fields title endpoint sendAs response feedback token model color">
<template>
  <bowery-analytics id="analytics"></bowery-analytics>
  <link rel="stylesheet" href="out.css">
  <style>
  form {
    padding-top: 9px;
    overflow: auto;
    height: 377px;
  }
  :host {
    height: 100%;
  }
  .card .unclickable {
    cursor: pointer;
  }
  </style>
  <form id="form" class="{{color}}">
    <template repeat="{{field in fields}}">
      <template if="{{field.type == 'hidden'}}">
        <input id="{{field.name}}" type="hidden" value="{{field.value || model[field.name]}}">
      </template>
      <template if="{{field.type == 'button'}}">
        <div class="card images" on-click="{{navigate}}" href="{{field.path}}">
          <template if="{{field.value || model[field.name]}}">
            <h4>{{field.value || model[field.name]}}</h4>
          </template>
          <span class="unclickable">Click to edit image.</span>
        </div>
      </template>
      <template if="{{field.type != 'hidden' && field.type != 'button'}}">
        <div class="field-group" class="{{color}}">
          <input id="{{field.name}}" type="{{field.type || 'text'}}" name="{{field.name}}" placeholder="{{field.placeholder}}" value="{{field.value || model[field.name]}}" on-keyup="{{submitIfEnter}}" on-focus="{{makeActive}}" on-blur="{{trackInput}}">
          <label style="{{field.error && 'color: #FF6656'}}">{{field.error || field.label || field.name | makeReadable}}</label>
        </div>
      </template>
    </template>
    <content></content>
  </form>

  <bowery-nav type="footer" background="{{color}} active" on-click="{{postForm}}">{{title}}</bowery-nav>
  <core-ajax id="ajax"
    url="{{endpoint}}"
    method="POST"
    on-core-complete="{{emitResult}}"
    handleAs="json">
  </core-ajax>
</template>
<script>
Polymer({
  created: function () {
    this.fields = []
    this.model = {}
  },
  makeReadable: function (str) {
    strs = str.replace('-', ' ').replace('_', ' ').split(' ')
    return strs.map(function (str) {
      return str.charAt(0).toUpperCase() + str.slice(1)
    }).join(' ')

  },
  submitIfEnter: function (e) {
    if (e.keyCode == 13) {
      this.$.analytics.track('Submited Form with Enter Key')
      this.postForm(e)
    }
  },
  postForm: function (e) {
    e.preventDefault()
    var params = {cacheBuster: Date.now()}
    params.token = this.token

    for (var i = 0, field; field = this.fields[i]; i++)
      if (this.$[field.name])
        params[field.name] = this.model[field.name] = this.$[field.name].value

    if (this.sendAs == "json") {
      this.$.ajax.contentType = "application/json"
      this.$.ajax.body = JSON.stringify(params)
    }

    if (this.endpoint) {
      this.$.ajax.params = JSON.stringify(params)
      this.$.ajax.go()
    } else {
      this.fire('bowery-form-response', {fields: this.fields, model: this.model})
    }

    this.$.analytics.track('Submitted ' + this.title + ' Form', params)
  },
  emitResult: function (e, detail) {
    try {
      this.response = JSON.parse(detail.xhr.responseText)
    } catch (e) {
      this.response = {
        status: 'failed',
        error: 'internal server error'
      }
    }

    if (this.response.error) {
      this.$.analytics.track("Failed Form Post Attempt (" + this.title + ")", {error: this.response.error})
      var affectedField
      var error = this.response.error
      console.log('$$$ error', error)

      if (error == 'Incorrect Password') {
        affectedField = 'password'
      }

      if (~error.indexOf('No such developer with email') || ~error.indexOf('email address must contain a single @')) {
        affectedField = 'email'
      }

      for (var i = 0; i < this.fields.length; i++) {
        if (this.fields[i].name == affectedField) {
          this.fields[i].error = error
        } else {
          this.fields[i].error = ""
        }
      }
      return
    }

    this.fire('bowery-form-response', {fields: this.fields, model: this.model})
  },
  navigate: function (path) {
    var self = this
    if (typeof path != "string") {
      var e = path
      e.preventDefault()
      path = e.target.getAttribute('href') || e.target.parentNode.getAttribute('href')
    }
    console.log('$$$ nav to', path)
    this.$.analytics.track('Navigated to ' + path)

    this.fire('bowery-navigate', {path: path})
  },
  makeActive: function (e) {
    var el = e.target.parentNode
    console.log('add active b/c focus', el)
    el.setAttribute('class', el.getAttribute('class') + " active " + this.color)
  },
  trackInput: function (e) {

    var el = e.target.parentNode
    console.log('Remove active b/c blur', el)
    el.setAttribute('class', el.getAttribute('class').replace('active ' + this.color, ''))

    if (!e.target.value) return // don't track if they didn't type anything

    this.$.analytics.track('Entered Input Text', {
      field: e.target.name,
      value: e.target.value
    })
  }
})
</script>
</polymer-element>
