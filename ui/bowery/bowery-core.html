<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-core` is the bowery desktop app

@group Bowery Core Elements
@element bowery-core
-->
<link rel="import" href="bowery-screen.html">
<link rel="import" href="bowery-nav.html">
<link rel="import" href="bowery-list.html">
<link rel="import" href="bowery-form.html">
<link rel="import" href="bowery-payment.html">
<link rel="import" href="bowery-shell.html">
<link rel="import" href="bowery-image-select.html">
<link rel="import" href="bowery-analytics.html">
<link rel="import" href="../components/core-localstorage/core-localstorage.html">
<link rel="import" href="../components/core-ajax/core-ajax.html">

<polymer-element name="bowery-core" attributes="developer">
<template>
<bowery-analytics id="analytics"></bowery-analytics>
<core-localstorage id="db" name="bowery-developer" value="{{developer}}"></core-localstorage>
<core-localstorage id="keys" name="aws-keys" value="{{keys}}"></core-localstorage>
<link rel="stylesheet" href="out.css">
<style>
  span, pre {
    color: white;
  }
  :host {
    overflow: hidden;
  }

  .test-modal {
    position: relative;
    background: white;
    height: 45px;
    width: 345px;
    margin-top: 80px;
    margin-left: 9px;
  }
  .images {
    background: #361B4B;
  }
  .btn.half {
    width: 50%;
    float: left;
    text-align: center;
  }
</style>
<bowery-screen path="/login">
  <bowery-nav type="header" background="devs active">Bowery</bowery-nav>
  <bowery-form id="loginForm" color="devs" title="login" on-bowery-form-response="{{handleLoginAttempt}}" endpoint="http://broome.io/developers/token" fields="{{loginFields}}" sendAs="json">
    <a id="resetButton" class="btn devs" href="" on-click="{{resetPassword}}">I forgot my password.</a>
  </bowery-form>
</bowery-screen>

<bowery-screen path="/signup">
  <bowery-nav type="header" background="devs active">Bowery</bowery-nav>
  <bowery-form color="devs" title="signup" endpoint="http://broome.io/developers" fields="{{signupFields}}" on-bowery-form-response="{{handleSignupAttempt}}" sendAs="json">
    <a class="btn devs" href="/login" on-click="{{navigate}}">I already have a bowery account.</a>
  </bowery-form>
</bowery-screen>

<bowery-screen path="/pay">
  <bowery-nav type="header" background="devs active">Trial Expired</bowery-nav>
  <bowery-payment class="devs" developer="{{developer}}">
    <a class="btn devs" href="http://bowery.io" on-click="{{openExternalWindow}}">See Pricing Info</a>
  </bowery-payment>
</bowery-screen>

<bowery-screen path="/keys">
  <bowery-nav type="header" background="devs active">Bowery</bowery-nav>
  <bowery-form color="devs" title="Connect AWS" endpoint="http://localhost:32055/auth/validate-keys" fields="{{keyFields}}" model="{{keys}}" on-bowery-form-response="{{handleKeysAttempt}}" sendAs="json">
    <a class="btn devs" href="/apps/new" on-click="{{clearKeysAndNavigate}}">Have Bowery host it instead.</a>
  </bowery-form>
</bowery-screen>

<bowery-screen path="/apps">
  <bowery-nav type="header" background="apps active">Apps</bowery-nav>
  <bowery-list type="apps" item="{{app}}" list="{{applications}}" keys="{{keys}}" token="{{developer.token}}"></bowery-list>
  <bowery-nav type="footer" background="apps active" href="/keys" on-click="{{navigate}}">Add App</bowery-nav>
</bowery-screen>

<bowery-screen path="/apps/exec">
  <bowery-nav type="header" background="images active">Exec</bowery-nav>
  <bowery-shell app="{{app}}" logs="{{app.logs}}" token="{{developer.token}}"></bowery-shell>
  <bowery-nav type="footer" background="images active" href="/apps" on-click="{{navigate}}">Back</bowery-nav>
</bowery-screen>

<bowery-screen path="/apps/edit">
  <bowery-nav type="header" background="apps active">{{app.name}}</bowery-nav>
  <bowery-form title="Save" color="apps" endpoint="http://localhost:32055/applications/{{app._id}}" model="{{app}}" fields="{{editAppFields}}" sendAs="json" on-bowery-form-response="{{handleEditAppAttempt}}" token="{{developer.token}}"></bowery-form>
</bowery-screen>

<bowery-screen path="/images/edit">
  <bowery-nav type="header" background="images active">{{image.name || 'Publish Image'}}</bowery-nav>
  <bowery-form title="Publish" color="images" endpoint="http://localhost:32055/environments/{{image.id}}" model="{{image}}" fields="{{editImageFields}}" sendAs="json" on-bowery-form-response="{{handleEditImageAttempt}}" token="{{developer.token}}">
    <a href="/apps" class="btn images" on-click="{{navigate}}">Nevermind. Take me back.</a>
  </bowery-form>
</bowery-screen>

<bowery-screen path="/apps/new">
  <bowery-nav type="header" background="images active">Select Image</bowery-nav>
  <bowery-image-select title="Provision" color="apps" on-bowery-app-create-response="{{handleCreateAppAttempt}}" token="{{developer.token}}" app="{{app}}" keys="{{keys}}"></bowery-image-select>
  <bowery-nav type="footer" background="images active" href="/apps" on-click="{{navigate}}">Back</bowery-nav>
</bowery-screen>

<core-ajax id="ajax" handleAs="json" on-core-response="{{getUserByToken}}" auto></core-ajax>
<core-ajax id="resetAjax" method="POST" handleAs="json" on-core-response="{{handleResetAttempt}}" url="http://localhost:32055/auth/password-reset"></core-ajax>
<core-ajax id="appsAjax" handlAs="json" on-core-response="{{getApps}}" on-core-error="{{logout}}" url="http://localhost:32055/applications?token={{developer.token}}" auto></core-ajax>
<core-ajax id="updateAjax" handleAs="json" on-core-response="{{checkUpdate}}" url="http://localhost:32055/update/check" auto></core-ajax>
</template>
<script src="gifstream.js" type="text/javascript"></script>
<script>
Polymer('bowery-core', {
  created: function () {
    // The current app being shown
    this.app = {}

    // The current image
    this.image = {}

    // All of the current users application
    this.applications = []

    // The current user
    this.developer = {}

    // Map of aws keys
    this.keys = {aws_access_key: '', aws_secret_key: ''}

    // The new version of Bowery Desktop
    this.newVersion = '0.0.0'
  },
  loginFields: [
    {name: 'email', placeholder: 'your@email.com'},
    {name: 'password', placeholder: '**********', type: 'password'}
  ],
  signupFields: [
    {name: 'name', placeholder: 'Best Friend'},
    {name: 'email', placeholder: 'your@email'},
    {name: 'password', type: 'password', placeholder: '************'}
  ],
  forgotFields: [
    {name: 'email', placeholder: 'your@email.com'}
  ],
  keyFields: [
    {name: 'aws_access_key', label: 'AWS Access Key', placeholder: 'AWS+ACCESS+KEY+GOES+HERE'},
    {name: 'aws_secret_key', label: 'AWS Secret Key',  placeholder: 'AWS+SECRET+KEY+GOES+HERE'}
  ],
  editAppFields: [
    {name: 'name', label: 'What do we call this app?', placeholder: 'Your App'},
    {name: 'start', label: 'How do we run the app?', value: './web-app'},
    {name: 'remotePath', label: 'Where on the VM should we sync your code?', value: '/home/ubuntu/app'},
    {name: 'localPath', label: 'Where is the code on your computer?', value: '~/Documents/app'}
  ],
  editImageFields: [
    {name: 'name', placeholder: 'Image Name'},
    {name: 'description', placeholder: 'A short description'}
  ],
  ready: function () {
    this.$.analytics.track("Opened App")

    // Drag & Drop Swag
    window.addEventListener('dragenter', function (e) {
      e.stopPropagation()
      e.preventDefault()
    })
    window.addEventListener('dragover', function (e) {
      e.stopPropagation()
      e.preventDefault()
    })
    window.addEventListener('drop', this.handleDroppedFile.bind(this))

    this.$.db.load()
    this.$.keys.load()

    var sse = new EventSource('http://localhost:32055/_/sse')
    sse.addEventListener('message', this.handleSSE.bind(this))

    if (!this.developer.token) {
      return this.navigate('/signup')
    }

    var aMonthAgo = Date.now() - (1000 * 60 * 60 * 24 * 30)
    if (!this.developer.isPaid && this.developer.createdAt < aMonthAgo) {
      return this.navigate('/pay')
    }

    this.keyFields[0].value = this.keys.aws_access_key
    this.keyFields[1].value = this.keys.aws_secret_key

    this.$.updateAjax.go()

    this.navigate('/apps')
  },
  handleDroppedFile: function (e) {
    e.preventDefault()
    var file = e.dataTransfer.files[0]
    if (!~file.path.indexOf('.')) {
      return this.createAppFromDroppedFolder(file)
    }
    if (file.type == "image/gif") {
      return this.createAppFromDroppedImage(file)
    }
    alert('Bowery Image/App Not Found')
  },
  createAppFromDroppedFolder: function (file) {
    this.defaultLocalPath = file.path
    this.navigate('/apps/new')
  },
  createAppFromDroppedImage: function (file) {
    var self = this
    var reader = new FileReader();
    reader.onload = function (evt) {
      (new GifStream(evt.target.result)).parseID(self.populateNewAppScreen.bind(self))
    }
    reader.readAsBinaryString(file)
  },
  populateNewAppScreen: function (comExt) {
    var envID = comExt && comExt.comment

    this.app = {}
    this.navigate("/apps/new")
  },
  handleSSE: function (e) {
    var event = JSON.parse(e.data)
    console.log('$$$ event', event)
    if (event.type == 'status') {
      for (var i in this.applications) {
        if (event.appID == this.applications[i]._id) {
          this.applications[i] = event.message
        }
        if (event.appID == this.app._id) {
          this.app = event.message
        }
      }
      return
    }

    if (event.type == 'sync')
      this.$.analytics.track('Sync Event: ' + event.status)

    if (event.type == 'log' && (!event.appID || this.app._id == event.appID) && event.message) {
      this.app.logs += event.message
    }
  },
  handleCreateAppAttempt: function (e, detail) {
    var response = e.target.response

    this.app = response.application
    this.app.localPath = this.defaultLocalPath
    this.applications.push(this.app)

    this.editAppFields[1].value = this.app.environment ? this.app.environment.name : this.app.envId

    this.navigate('/apps')
  },
  handleEditAppAttempt: function (e, detail) {
    var response = e.target.response
    var ids = this.applications.map(function (a) {return a._id})
    if (~ids.indexOf(response.application._id)) {
      for (var i = 0, app; app = this.applications[i]; i++)
        if (app._id == response.application._id)
          this.applications[i] = response.application
    } else {
      this.applications.push(response.application)
    }

    this.app = {}
    this.navigate('/apps')
  },
  handleEditImageAttempt: function (e, detail) {
    var response = e.target.response
    this.app.environment.name = this.image.name
    this.app.image = this.app.environment.name
    this.app.environment.description = this.image.description
    this.navigate('/apps')
  },
  handleLoginAttempt: function (e, detail) {
    var response = detail.response
    this.developer = {}
    this.developer.token = response.token
    this.$.ajax.url = "http://broome.io/developers/me?token=" + this.developer.token
    this.navigate('/apps')
  },
  getUserByToken: function (e, detail) {
    var response = detail.response
    if (response.status == "found") {
      this.developer = response.developer
      this.developer['$email'] = this.developer.email // bullshit => https://mixpanel.com/docs/properties-or-segments/special-or-reserved-properties
      this.$.analytics.register(this.developer)
    }
  },
  handleSignupAttempt: function (e, detail) {
    var response = detail.response
    this.developer = response.developer
    this.$.ajax.url = "http://broome.io/developers/me?token=" + this.developer.token
    this.$.db.save()

    return this.navigate('/apps')
  },
  handleKeysAttempt: function (e, detail) {
    var response = detail.response
    if (response.status == "success") {
      this.$.keys.save()
      return this.navigate('/apps/new')
    }
  },
  getApps: function (e, detail) {
    var r = JSON.parse(detail.response)
    if (r.status == "found")
      this.applications = r.applications
    else
      this.logout()
  },
  openExternalWindow: function (path) {
    if (typeof path != "string") {
      var e = path
      e.preventDefault()
      path = e.target.getAttribute('href')
    }
    this.$.analytics.track('Opened external window ' + path)
    window.open(path, "", "resizable,scrollbars,status")
  },
  clearKeysAndNavigate: function (e) {
    this.$.analytics.track('Created Bowery Hosted Instance')
    this.keys = {aws_access_key: '', aws_secret_key: ''}
    this.navigate(e)
  },
  navigate: function (path) {
    var self = this
    if (typeof path != "string") {
      var e = path
      e.preventDefault()
      path = e.target.getAttribute('href') || e.target.parentNode.getAttribute('href')
    }

    // reset everytime they go to the '/keys' screen
    if (path == '/keys')
      this.useTheirKeys = false

    this.$.analytics.track('Navigated to ' + path)
    this.fire('bowery-navigate', {path: path})
  },
  appChanged: function (oldApp, newApp) {
    this.image = this.app.environment
  },
  checkUpdate: function(e, detail) {
    e.preventDefault()

    if (detail.response.status == 'new-update')
      this.newVersion = detail.response.version
  },
  resetPassword: function (e) {
    e.preventDefault()
    var email = this.$.loginForm.fieldValue('email')
    if (!email) return this.$.loginForm.showError('email', 'Email required to reset password')
    this.$.resetAjax.body = JSON.stringify({email: email})
    this.$.resetAjax.go()
  },
  handleResetAttempt: function (e, detail) {
    var r = e.detail.response
    if (r.status == "success")
      this.$.resetButton.innerHTML = "Help is on the way! Check your email."
    else
      alert(r.error)
  },
  logout: function () {
    this.developer = {}
    this.$.db.save()
    this.navigate('/signup')
  }
})
</script>
</polymer-element>
