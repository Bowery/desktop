<!--
Copyright (c) 2014 Bowery, Inc. All rights reserved.
-->

<!--
`bowery-core` is the bowery desktop app

@group Bowery Core Elements
@element bowery-core
-->
<link rel="import" href="bowery-screen.html">
<link rel="import" href="bowery-nav.html">
<link rel="import" href="bowery-list.html">
<link rel="import" href="bowery-form.html">
<link rel="import" href="bowery-payment.html">
<link rel="import" href="bowery-analytics.html">
<link rel="import" href="../components/core-localstorage/core-localstorage.html">
<link rel="import" href="../components/core-ajax/core-ajax.html">

<polymer-element name="bowery-core" attributes="developer">
<template>
<bowery-analytics id="analytics"></bowery-analytics>
<core-localstorage id="db" name="bowery-developer" value="{{developer}}"></core-localstorage>
<link rel="stylesheet" href="out.css">
<style>
  span, pre {
    color: white;
  }
  :host {
    overflow: hidden;
  }

  .test-modal {
    position: relative;
    background: white;
    height: 45px;
    width: 345px;
    margin-top: 80px;
    margin-left: 9px;
  }
  .images {
    background: #361B4B;
  }
  .btn.half {
    width: 50%;
    float: left;
    text-align: center;
  }
</style>
<bowery-screen path="/login">
  <bowery-nav type="header" background="devs active">Bowery</bowery-nav>
  <bowery-form id="loginForm" color="devs" title="login" on-bowery-form-response="{{handleLoginResponse}}" endpoint="http://broome.io/developers/token" fields="{{loginFields}}" sendAs="json">
    <a id="resetButton" class="btn devs" href="" on-click="{{resetPassword}}">I forgot my password.</a>
  </bowery-form>
</bowery-screen>

<bowery-screen path="/signup">
  <bowery-nav type="header" background="devs active">Bowery</bowery-nav>
  <bowery-form color="devs" title="signup" endpoint="http://broome.io/developers" fields="{{signupFields}}" on-bowery-form-response="{{handleSignupResponse}}" sendAs="json">
    <a class="btn devs" href="/login" on-click="{{navigate}}">I already have a bowery account.</a>
  </bowery-form>
</bowery-screen>

<bowery-screen path="/pay">
  <bowery-nav type="header" background="devs active">Trial Expired</bowery-nav>
  <bowery-payment class="devs" developer="{{developer}}">
    <a class="btn devs" href="http://bowery.io/pricing" on-click="{{openExternalWindow}}">See Pricing Info</a>
  </bowery-payment>
</bowery-screen>

<bowery-screen path="/apps">
  <bowery-nav type="header" background="apps active">Apps</bowery-nav>
  <bowery-list type="apps" item="{{app}}" list="{{applications}}" keys="{{keys}}" token="{{developer.token}}">
    <a class="btn images" id="updateBtn" href="#" style="display: {{newVersion != '0.0.0' ? 'block': 'none'}}" on-click="{{downloadUpdate}}">Version {{newVersion}} available. Click to upgrade.</a>
  </bowery-list>
  <bowery-nav type="footer" background="apps active" href="/keys" on-click="{{selectCode}}">Add App</bowery-nav>
</bowery-screen>

<core-ajax id="ajax" handleAs="json" on-core-response="{{handleGetUserResponse}}" auto></core-ajax>
<core-ajax id="downloadAjax" handleAs="json" on-core-response="{{handleDownloadUpdateResponse}}" auto></core-ajax>
<core-ajax id="resetAjax" method="POST" handleAs="json" on-core-response="{{handleResetResponse}}" url="http://localhost:32055/auth/password-reset"></core-ajax>
<core-ajax id="appsAjax" handlAs="json" on-core-response="{{handleGetAppsResponse}}" on-core-error="{{logout}}" url="http://localhost:32055/applications?token={{developer.token}}" auto></core-ajax>
<core-ajax id="updateAjax" handleAs="json" on-core-response="{{handleCheckUpdateResponse}}" url="http://localhost:32055/update/check" auto></core-ajax>
<core-ajax id="mercerAjax" method="POST" handlAs="json" on-core-response="{{createAppFromMercerResponse}}" url="http://localhost:32055/code"></core-ajax>
</template>
<script>
Polymer('bowery-core', {

  // Lifecycle Methods (https://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods) //

  /**
   * Initialized variables as soon as this element is created so that polymer
   * can infer the types of each instance variable.
   */
  created: function () {
    // The current app being shown
    this.app = {}

    // All of the current users application
    this.applications = []

    // The current user
    this.developer = {}

    // The new version of Bowery Desktop
    this.newVersion = '0.0.0'
  },

  /**
   * These describe the fields passed to `<bowery-form>`
   */
  loginFields: [
    {name: 'email', placeholder: 'your@email.com'},
    {name: 'password', placeholder: '**********', type: 'password'}
  ],
  signupFields: [
    {name: 'name', placeholder: 'Best Friend'},
    {name: 'email', placeholder: 'your@email'},
    {name: 'password', type: 'password', placeholder: '************'}
  ],
  forgotFields: [
    {name: 'email', placeholder: 'your@email.com'}
  ],

  /**
   * Gets run on dom ready. It sets up event listeners and decides which page
   * to load.
   */
  ready: function () {
    this.$.analytics.track("Opened App")

    // Necessary to make Drag & Drop Work
    window.addEventListener('dragenter', function (e) {
      e.stopPropagation()
      e.preventDefault()
    })
    window.addEventListener('dragover', function (e) {
      e.stopPropagation()
      e.preventDefault()
    })
    window.ondrop = this.handleDroppedFile

    // Load the developer stored in localstorage
    this.$.db.load()

    // Bind server side events to this.handleSSE
    var sse = new EventSource('http://localhost:32055/_/sse')
    sse.addEventListener('message', this.handleSSE.bind(this))

    if (!this.developer.token) {
      return this.navigate('/signup')
    }

    var aMonthAgo = Date.now() - (1000 * 60 * 60 * 24 * 30)
    if (!this.developer.isPaid && this.developer.createdAt < aMonthAgo) {
      return this.navigate('/pay')
    }

    if (process.platform == 'darwin')
      this.$.updateAjax.go()

    this.navigate('/apps')
  },

  // Event Listeners //

  /**
   * Handles server side events like logs, code sync, or app statuses
   */
  handleSSE: function (e) {
    var event = JSON.parse(e.data)
    console.log('$$$ event', event)
    if (event.type == 'status') {
      for (var i in this.applications) {
        if (event.appID == this.applications[i]._id) {
          this.applications[i] = event.message
        }
        if (event.appID == this.app._id) {
          this.app = event.message
        }
      }
      return
    }

    if (event.type == 'sync')
      this.$.analytics.track('Sync Event: ' + event.status)

    if (event.type == 'log' && (!event.appID || this.app._id == event.appID) && event.message) {
      this.app.logs += event.message
    }
  },
  /**
   * Gets called when an file/folder is dropped. Will create an app if the
   * dropped item is a directory.
   */
  handleDroppedFile: function (e) {
    e.preventDefault()
    var length = e.dataTransfer.items.length;
    for (var i = 0; i < length; i++) {
      var entry = e.dataTransfer.items[i].webkitGetAsEntry();
      if (!entry.isDirectory) {
        return alert('Please Drop a Directory not a file')
      }
      console.log('$$$$ displayPath', entry)
      // TODO (thebyrd) Convert DirectoryEntry js object to a path
      // path = "path/goes/here"
      // this.$.mercerAjax.body = JSON.stringify({path: path})
      // this.$.mercerAjax.go()
    }
  },
  /**
   * Called when the add app button is clicked. It uses the atom shell dialog
   * to select files and create an app instead of drag and drop.
   */
  selectCode: function (e) {
    e.preventDefault()
    var paths = require('remote').require('dialog').showOpenDialog({
      title: 'Where is your code?',
      properties: ['openDirectory']
    })
    if (paths && paths.length) {
      console.log('upload', paths[0])
      this.$.mercerAjax.body = JSON.stringify({path: paths[0]})
      this.$.mercerAjax.go()
    }
  },
  /**
   * Attempts to download OS X Installer when there's an update
   */
  downloadUpdate: function(e) {
    e.preventDefault()
    if (!this.updateInProgress && this.newVersion != '0.0.0') {
      this.$.downloadAjax.url = 'http://localhost:32055/update/' + this.newVersion
      this.$.updateBtn.innerHTML = 'Downloading update. This may take a minute.'
      this.updateInProgress = true
    }
  },
  /**
   * Makes a request to reset the users password. Called when they click the
   * I forgot my password button.
   */
  resetPassword: function (e) {
    e.preventDefault()
    var email = this.$.loginForm.fieldValue('email')
    if (!email) return this.$.loginForm.showError('email', 'Email required to reset password')
    this.$.resetAjax.body = JSON.stringify({email: email})
    this.$.resetAjax.go()
  },
  /**
   * Handles the response from mercer.io
   */
  createAppFromMercerResponse: function () {
    console.log('$$$ createAppFromMercerResponse', arguments)
  },


  // Handle Ajax Responses //

  /**
   * Handles Login response from Broome.io
   */
  handleLoginResponse: function (e, detail) {
    var response = detail.response
    this.developer = {}
    this.developer.token = response.token
    this.$.ajax.url = "http://broome.io/developers/me?token=" + this.developer.token
    this.navigate('/apps')
  },
  /**
   * Handles Signup response from Broome.io
   */
  handleSignupResponse: function (e, detail) {
    var response = detail.response
    this.developer = response.developer
    this.$.ajax.url = "http://broome.io/developers/me?token=" + this.developer.token
    this.$.db.save()

    return this.navigate('/apps')
  },
  /**
   * Signup/Login only give a token, so we use that to get the user from Broome
   * and we handle the response from that request here.
   */
  handleGetUserResponse: function (e, detail) {
    var response = detail.response
    if (response.status == "found") {
      this.developer = response.developer
      this.developer['$email'] = this.developer.email // bullshit => https://mixpanel.com/docs/properties-or-segments/special-or-reserved-properties
      this.$.analytics.register(this.developer)
    }
  },
  /**
   * Loads the user's apps
   */
  handleGetAppsResponse: function (e, detail) {
    var r = JSON.parse(detail.response)
    if (r.status == "found")
      this.applications = r.applications
    else
      this.logout()
  },
  /**
   * If there's an update is changes this.newVersion so that an update button
   * will become visible. #dataBindingBlackMagic
   */
  handleCheckUpdateResponse: function(e, detail) {
    e.preventDefault()

    if (detail.response.status == 'new-update')
      this.newVersion = detail.response.version
  },
  /**
   * Gives the user some feedback when the installer is running
   */
  handleDownloadUpdateResponse: function (e) {
    console.log('$$$ here')
    this.$.updateBtn.innerHTML = 'Walk through the installer and restart the app to apply update.'
  },
  /**
   * Handles password reset request attempt from Broome.io.
   */
  handleResetResponse: function (e, detail) {
    var r = e.detail.response
    if (r.status == "success")
      this.$.resetButton.innerHTML = "Help is on the way! Check your email."
    else
      alert(r.error)
  },

  // Utility Functions //

  /**
   * Opens an external webview window
   */
  openExternalWindow: function (path) {
    if (typeof path != "string") {
      var e = path
      e.preventDefault()
      path = e.target.getAttribute('href')
    }
    this.$.analytics.track('Opened external window ' + path)
    window.open(path, "", "resizable,scrollbars,status")
  },
  /**
   * Shows the <bowery-screen> with the given `path` attribute.
   */
  navigate: function (path) {
    var self = this
    if (typeof path != "string") {
      var e = path
      e.preventDefault()
      path = e.target.getAttribute('href') || e.target.parentNode.getAttribute('href')
    }

    this.$.analytics.track('Navigated to ' + path)
    this.fire('bowery-navigate', {path: path})
  },
  logout: function () {
    this.developer = {}
    this.$.db.save()
    this.navigate('/signup')
  }
})
</script>
</polymer-element>
